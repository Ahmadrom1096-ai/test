<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ujian Online</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 1em; }
    .soal-block { margin-bottom: 2em; }
  </style>
</head>
<body>

  <h2>Ujian Online</h2>
  <div id="status">Memuat soal...</div>

  <form id="form-ujian">
    <div id="soal_teknis"></div>
    <div id="soal_psikologi"></div>
    <button type="submit">Kirim Jawaban</button>
  </form>

  <script>
    const token = new URLSearchParams(window.location.search).get("token");

    if (!token) {
      document.getElementById("status").innerText = "Token tidak ditemukan di URL.";
      document.getElementById("form-ujian").style.display = "none";
    } else {
      fetch(`https://script.google.com/macros/s/AKfycbyF_comq7SOJU-1WlH8rbnOTPdhi6cDjR1RmC-zuq9VADqsRXmYd3UUGKG-pOKOZLD-/exec?token=${token}`)
        .then(res => res.json())
        .then(data => {
          if (data.status !== "success") {
            document.getElementById("status").innerText = "Token tidak valid atau soal tidak ditemukan.";
            return;
          }

          document.getElementById("status").style.display = "none";

          renderSoal(data.soal_teknis, "soal_teknis", "Teknis");
          renderSoal(data.soal_psikologi, "soal_psikologi", "Psikologi");
        })
        .catch(err => {
          document.getElementById("status").innerText = "Gagal memuat soal.";
          console.error(err);
        });
    }

    function renderSoal(soals, containerId, kategori) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<h3>Soal ${kategori}</h3>`;
      soals.forEach((soal, i) => {
        const block = document.createElement("div");
        block.className = "soal-block";
        block.innerHTML = `
          <p>${i + 1}. ${soal.question_text}</p>
          ${["A", "B", "C", "D"].map(op =>
            `<label><input type="radio" name="${kategori}_${i}" value="${op}"> ${op}. ${soal.options[op]}</label><br>`
          ).join("")}
        `;
        container.appendChild(block);
      });
    }

    document.getElementById("form-ujian").addEventListener("submit", async function(e) {
      e.preventDefault();

      const getJawaban = (kategori, jumlah) => {
        const hasil = [];
        for (let i = 0; i < jumlah; i++) {
          const jawaban = document.querySelector(`input[name="${kategori}_${i}"]:checked`);
          hasil.push(jawaban ? jawaban.value : null);
        }
        return hasil;
      };

      const jumlahTeknis = document.querySelectorAll('[name^="Teknis_"]').length / 4;
      const jumlahPsikologi = document.querySelectorAll('[name^="Psikologi_"]').length / 4;

      const payload = {
        token: token,
        answers_teknis: getJawaban("Teknis", jumlahTeknis),
        answers_psikologi: getJawaban("Psikologi", jumlahPsikologi)
      };

      const res = await fetch("https://script.google.com/macros/s/AKfycbyF_comq7SOJU-1WlH8rbnOTPdhi6cDjR1RmC-zuq9VADqsRXmYd3UUGKG-pOKOZLD-/exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();
      alert(`Jawaban dikirim! Skor Teknis: ${result.skor_teknis}, Psikologi: ${result.skor_psikologi}`);
    });
  </script>
</body>
</html>
