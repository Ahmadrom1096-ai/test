<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Ujian Online - Shankara Group</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      margin-bottom: 1rem;
    }
    .soal-block {
      margin-bottom: 2rem;
    }
    .soal-block p {
      margin: 0.5rem 0;
    }
    .result {
      background: #e0ffe0;
      padding: 1rem;
      margin-top: 2rem;
      border: 1px solid #0a0;
    }
    button {
      padding: 0.5rem 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <h2>Ujian Tulis Online â€“ Shankara Group</h2>
  <p id="status">Memuat soal...</p>

  <form id="form-ujian" style="display: none;">
    <div id="soal_teknis"></div>
    <div id="soal_psikologi"></div>
    <button type="submit">Kirim Jawaban</button>
  </form>

  <div class="result" id="hasil" style="display: none;"></div>

  <script>
    const token = new URLSearchParams(window.location.search).get("token");
    const endpoint = "https://script.google.com/macros/s/AKfycbxpIYc3doCpsG8qvVeqq9iJF3hUqeKaZLKG4ngejA1JGneIM1oApNH4rg3EWw8rqd4j1g/exec";

    if (!token) {
      document.getElementById("status").innerText = "Token tidak ditemukan di URL.";
      document.getElementById("form-ujian").style.display = "none";
    } else {
      fetch(`${endpoint}?token=${token}`)
        .then(res => res.json())
        .then(data => {
          if (data.status !== "success") {
            document.getElementById("status").innerText = "Token tidak valid atau soal tidak ditemukan.";
            return;
          }

          document.getElementById("status").style.display = "none";
          document.getElementById("form-ujian").style.display = "block";

          renderSoal(data.soal_teknis, "soal_teknis", "Teknis");
          renderSoal(data.soal_psikologi, "soal_psikologi", "Psikologi");
        })
        .catch(err => {
          document.getElementById("status").innerText = "Gagal memuat soal.";
          console.error(err);
        });
    }

    function renderSoal(soals, containerId, kategori) {
      const container = document.getElementById(containerId);
      container.innerHTML = `<h3>Soal ${kategori}</h3>`;
      soals.forEach((soal, i) => {
        const div = document.createElement("div");
        div.className = "soal-block";
        div.innerHTML = `
          <p><strong>${i + 1}.</strong> ${soal.question_text}</p>
          ${Object.keys(soal.options).map(opt => `
            <label>
              <input type="radio" name="${containerId}_${i}" value="${opt}"> ${opt}. ${soal.options[opt]}
            </label><br/>
          `).join("")}
        `;
        container.appendChild(div);
      });
    }

    function getJawaban(kategori) {
      const radios = document.querySelectorAll(`input[name^="${kategori}_"]`);
      const jumlahSoal = [...new Set([...radios].map(r => r.name))].length;
      const jawaban = [];

      for (let i = 0; i < jumlahSoal; i++) {
        const checked = document.querySelector(`input[name="${kategori}_${i}"]:checked`);
        jawaban.push(checked ? checked.value : null);
      }

      return jawaban;
    }

    document.getElementById("form-ujian").addEventListener("submit", function (e) {
      e.preventDefault();

      const button = e.target.querySelector("button");
      button.disabled = true;
      button.innerText = "Mengirim...";

      const answers_teknis = getJawaban("soal_teknis");
      const answers_psikologi = getJawaban("soal_psikologi");

      const payload = {
        token,
        answers_teknis,
        answers_psikologi
      };

      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(result => {
          if (result.status === "success") {
            document.getElementById("form-ujian").style.display = "none";
            document.getElementById("hasil").style.display = "block";
            document.getElementById("hasil").innerHTML = `
              <h3>Terima kasih!</h3>
              <p>Jawaban Anda berhasil dikirim.</p>
              <p>Skor Teknis: <strong>${result.skor_teknis}</strong></p>
              <p>Skor Psikologi: <strong>${result.skor_psikologi}</strong></p>
            `;
          } else {
            alert("Gagal mengirim jawaban: " + result.message);
            button.disabled = false;
            button.innerText = "Kirim Jawaban";
          }
        })
        .catch(error => {
          console.error("Gagal submit:", error);
          alert("Terjadi kesalahan saat mengirim jawaban. Coba lagi nanti.");
          button.disabled = false;
          button.innerText = "Kirim Jawaban";
        });
    });
  </script>
</body>
</html>
